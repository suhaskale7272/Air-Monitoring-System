<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIR QUALITY INDEX MONITORING</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --dark-color: #333;
            --light-color: #f4f4f4;
            --danger-color: #ff6b6b;
            --warning-color: #ffb142;
            --success-color: #1dd1a1;
            --pm25-color: #9c27b0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            width: 90%;
            max-width: 1300px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-align: center;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .location {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1rem;
            margin-top: 1rem;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        
        .card-title {
            font-size: 1.25rem;
            color: var(--primary-color);
        }
        
        .card-icon {
            font-size: 1.5rem;
            color: var(--secondary-color);
        }
        
        .reading {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin: 1.5rem 0;
        }
        
        .reading-unit {
            font-size: 1rem;
            color: #888;
        }
        
        .chart-container {
            height: 200px;
            margin-top: 1rem;
        }
        
        .status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
        }
        
        .status-good {
            background-color: var(--success-color);
        }
        
        .status-moderate {
            background-color: var(--warning-color);
        }
        
        .status-poor {
            background-color: var(--danger-color);
        }
        
        .status-unhealthy {
            background-color: #8e44ad;
        }
        
        .status-hazardous {
            background-color: #2c3e50;
        }
        
        .charts {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }
        
        .chart-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .chart-tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .chart-tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .chart-panel {
            display: none;
            height: 400px;
        }
        
        .chart-panel.active {
            display: block;
        }
        
        .prediction {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-top: 2rem;
        }
        
        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        
        .prediction-title {
            font-size: 1.25rem;
            color: var(--primary-color);
        }
        
        .prediction-result {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .prediction-item {
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 0.5rem;
            border-left: 4px solid var(--primary-color);
        }
        
        .prediction-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .prediction-value {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .footer {
            text-align: center;
            margin-top: 2rem;
            padding: 1rem;
            color: #888;
            font-size: 0.875rem;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background-color: rgba(255, 107, 107, 0.1);
            border-left: 4px solid var(--danger-color);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.25rem;
        }
        
        .refresh-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .refresh-btn:hover {
            background-color: #388e3c;
        }

        #data-table {
            width: 100%;
            margin-top: 2rem;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        #data-table th, #data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        #data-table th {
            background-color: #f4f4f4;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        #data-table tr:last-child td {
            border-bottom: none;
        }
        
        #data-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .download-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .download-btn:hover {
            background-color: #0b7dda;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AIR QUALITY INDEX MONITORING</h1>
            <p>Real-time environmental data monitoring and analysis</p>
            <div class="location">
                <span id="location-icon">üìç</span>
                <span id="current-location">Loading location...</span>
            </div>
        </header>
        
        <div class="dashboard">
            <div class="card" id="temperature-card">
                <div class="card-header">
                    <h2 class="card-title">Temperature</h2>
                    <span class="card-icon">üå°Ô∏è</span>
                </div>
                <div class="reading" id="temperature-reading">
                    -- <span class="reading-unit">¬∞C</span>
                </div>
                <div class="chart-container">
                    <canvas id="temperature-chart"></canvas>
                </div>
            </div>
            
            <div class="card" id="humidity-card">
                <div class="card-header">
                    <h2 class="card-title">Humidity</h2>
                    <span class="card-icon">üíß</span>
                </div>
                <div class="reading" id="humidity-reading">
                    -- <span class="reading-unit">%</span>
                </div>
                <div class="chart-container">
                    <canvas id="humidity-chart"></canvas>
                </div>
            </div>
            
            <div class="card" id="gas-card">
                <div class="card-header">
                    <h2 class="card-title">Gas Level</h2>
                    <span class="card-icon">üå´Ô∏è</span>
                </div>
                <div class="reading" id="gas-reading">
                    -- <span class="reading-unit">ppm</span>
                </div>
                <div>
                    <span class="status" id="gas-status">Unknown</span>
                </div>
                <div class="chart-container">
                    <canvas id="gas-chart"></canvas>
                </div>
            </div>
            
            <!-- NEW PM2.5 CARD -->
            <div class="card" id="pm25-card">
                <div class="card-header">
                    <h2 class="card-title">PM2.5</h2>
                    <span class="card-icon">üè≠</span>
                </div>
                <div class="reading" id="pm25-reading">
                    -- <span class="reading-unit">Œºg/m¬≥</span>
                </div>
                <div>
                    <span class="status" id="pm25-status">Unknown</span>
                </div>
                <div class="chart-container">
                    <canvas id="pm25-chart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="charts">
            <div class="chart-tabs">
                <div class="chart-tab active" data-tab="all-parameters">All Parameters</div>
                <div class="chart-tab" data-tab="gas-details">Gas Details</div>
                <div class="chart-tab" data-tab="pm25-details">PM2.5 Details</div>
                <div class="chart-tab" data-tab="correlation">Correlation</div>
            </div>
            
            <div class="chart-panel active" id="all-parameters-panel">
                <canvas id="all-parameters-chart"></canvas>
            </div>
            
            <div class="chart-panel" id="gas-details-panel">
                <canvas id="gas-details-chart"></canvas>
            </div>
            
            <!-- NEW PM2.5 DETAILS PANEL -->
            <div class="chart-panel" id="pm25-details-panel">
                <canvas id="pm25-details-chart"></canvas>
            </div>
            
            <div class="chart-panel" id="correlation-panel">
                <canvas id="correlation-chart"></canvas>
            </div>
        </div>
        
        <div class="prediction">
            <div class="prediction-header">
                <h2 class="prediction-title">AI Prediction Results</h2>
                <button class="refresh-btn" id="refresh-prediction">
                    Refresh Prediction
                </button>
            </div>
            
            <div class="prediction-result">
                <div class="prediction-item">
                    <div class="prediction-label">Predicted Gas Level</div>
                    <div class="prediction-value" id="predicted-gas">--</div>
                </div>
                
                <div class="prediction-item">
                    <div class="prediction-label">Pollutant Type</div>
                    <div class="prediction-value" id="pollutant-type">--</div>
                </div>
                
                <div class="prediction-item">
                    <div class="prediction-label">Air Quality</div>
                    <div class="prediction-value" id="air-quality">--</div>
                </div>
                
                <div class="prediction-item">
                    <div class="prediction-label">Confidence Score</div>
                    <div class="prediction-value" id="confidence-score">--</div>
                </div>
            </div>
        </div>
        
        <div class="data-section">
            <h2>Historical Data</h2>
            <div id="table-container">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Temperature (¬∞C)</th>
                            <th>Humidity (%)</th>
                            <th>Gas (ppm)</th>
                            <th>PM2.5 (Œºg/m¬≥)</th>
                            <th>Pollutant Type</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        <tr>
                            <td colspan="6" class="loading">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button class="download-btn" id="download-csv">
                Download CSV Data
            </button>
        </div>
        
        <footer class="footer">
            <p>Air Quality Index Monitoring System ¬© 2025</p>
        </footer>
    </div>

    <script>
        const CHANNEL_ID = '2918627'; // Replace with your ThingSpeak channel ID
        const API_KEY = '3TW5RRLGEWUWSPES'; // Replace with your ThingSpeak read API key
        const MAX_POINTS = 10;
        let allData = [];
        let charts = {};
        let locationData = {};

        class AirQualityModel {
            constructor(data) {
                this.xgbCoefficients = {
                    temperature: 0.5,
                    humidity: 0.3,
                    intercept: 10
                };
                this.scalers = {
                    temperature: { mean: 25, std: 5 },
                    humidity: { mean: 60, std: 15 },
                    gas: { mean: 300, std: 150 },
                    pm25: { mean: 25, std: 15 }
                };
                if (data && data.length > 0) {
                    this.updateScalers(data);
                }
            }

            updateScalers(data) {
                const temps = data.map(d => d.temperature).filter(v => !isNaN(v));
                const hums = data.map(d => d.humidity).filter(v => !isNaN(v));
                const gases = data.map(d => d.gas).filter(v => !isNaN(v));
                const pm25s = data.map(d => d.pm25).filter(v => !isNaN(v));
                
                if (temps.length > 0) {
                    this.scalers.temperature.mean = temps.reduce((a, b) => a + b, 0) / temps.length;
                    this.scalers.temperature.std = Math.sqrt(
                        temps.reduce((a, b) => a + Math.pow(b - this.scalers.temperature.mean, 2), 0) / temps.length
                    ) || 1;
                }
                if (hums.length > 0) {
                    this.scalers.humidity.mean = hums.reduce((a, b) => a + b, 0) / hums.length;
                    this.scalers.humidity.std = Math.sqrt(
                        hums.reduce((a, b) => a + Math.pow(b - this.scalers.humidity.mean, 2), 0) / hums.length
                    ) || 1;
                }
                if (gases.length > 0) {
                    this.scalers.gas.mean = gases.reduce((a, b) => a + b, 0) / gases.length;
                    this.scalers.gas.std = Math.sqrt(
                        gases.reduce((a, b) => a + Math.pow(b - this.scalers.gas.mean, 2), 0) / gases.length
                    ) || 1;
                }
                if (pm25s.length > 0) {
                    this.scalers.pm25.mean = pm25s.reduce((a, b) => a + b, 0) / pm25s.length;
                    this.scalers.pm25.std = Math.sqrt(
                        pm25s.reduce((a, b) => a + Math.pow(b - this.scalers.pm25.mean, 2), 0) / pm25s.length
                    ) || 1;
                }
            }

            standardize(value, feature) {
                return (value - this.scalers[feature].mean) / this.scalers[feature].std;
            }

            unstandardize(value, feature) {
                return value * this.scalers[feature].std + this.scalers[feature].mean;
            }

            predict(temperature, humidity) {
                if (isNaN(temperature) || isNaN(humidity)) {
                    return 0;
                }
                const tempStd = this.standardize(temperature, 'temperature');
                const humidityStd = this.standardize(humidity, 'humidity');
                const gasStd =
                    this.xgbCoefficients.temperature * tempStd +
                    this.xgbCoefficients.humidity * humidityStd +
                    this.xgbCoefficients.intercept;
                return Math.max(0, this.unstandardize(gasStd, 'gas'));
            }

            detectGasType(concentration) {
                if (concentration < 12) {
                    return "Clean Air";
                } else if (concentration < 20) {
                    return "CO2 (Carbon Dioxide)";
                } else if (concentration < 30) {
                    return "NO2 (Nitrogen Dioxide)";
                } else if (concentration < 45) {
                    return "NH3 (Ammonia)";
                } else if (concentration < 60) {
                    return "CO (Carbon Monoxide)";
                } else {
                    return "Mixed Pollutants";
                }
            }

            calculateConfidence(temperature, humidity) {
                if (isNaN(temperature) || isNaN(humidity)) {
                    return "50.0%";
                }
                const tempDist = Math.abs(this.standardize(temperature, 'temperature'));
                const humDist = Math.abs(this.standardize(humidity, 'humidity'));
                let confidence = 100 - (tempDist + humDist) * 10;
                return Math.max(Math.min(confidence, 100), 50).toFixed(1) + '%';
            }

            getAirQuality(gasLevel) {
                if (gasLevel < 15) {
                    return { label: "Good", class: "status-good" };
                } else if (gasLevel < 50) {
                    return { label: "Moderate", class: "status-moderate" };
                } else {
                    return { label: "Poor", class: "status-poor" };
                }
            }

            // NEW PM2.5 Quality Assessment
            getPM25Quality(pm25Level) {
                if (pm25Level <= 12) {
                    return { label: "Good", class: "status-good" };
                } else if (pm25Level <= 35) {
                    return { label: "Moderate", class: "status-moderate" };
                } else if (pm25Level <= 55) {
                    return { label: "Unhealthy for Sensitive", class: "status-poor" };
                } else if (pm25Level <= 150) {
                    return { label: "Unhealthy", class: "status-unhealthy" };
                } else {
                    return { label: "Hazardous", class: "status-hazardous" };
                }
            }
        }

        let model = new AirQualityModel();

        function initCharts() {
            charts.temperature = new Chart(
                document.getElementById('temperature-chart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Temperature',
                            data: [],
                            borderColor: '#FF6384',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        maintainAspectRatio: false,
                        animation: {
                            duration: 500
                        }
                    }
                }
            );

            charts.humidity = new Chart(
                document.getElementById('humidity-chart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Humidity',
                            data: [],
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        maintainAspectRatio: false,
                        animation: {
                            duration: 500
                        }
                    }
                }
            );

            charts.gas = new Chart(
                document.getElementById('gas-chart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Gas',
                            data: [],
                            borderColor: '#4BC0C0',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        maintainAspectRatio: false,
                        animation: {
                            duration: 500
                        }
                    }
                }
            );

            // NEW PM2.5 CHART
            charts.pm25 = new Chart(
                document.getElementById('pm25-chart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'PM2.5',
                            data: [],
                            borderColor: '#9c27b0',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        maintainAspectRatio: false,
                        animation: {
                            duration: 500
                        }
                    }
                }
            );

            charts.allParameters = new Chart(
                document.getElementById('all-parameters-chart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Temperature (¬∞C)',
                                data: [],
                                borderColor: '#FF6384',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Humidity (%)',
                                data: [],
                                borderColor: '#36A2EB',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Gas (ppm)',
                                data: [],
                                borderColor: '#4BC0C0',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                yAxisID: 'y1'
                            },
                            {
                                label: 'PM2.5 (Œºg/m¬≥)',
                                data: [],
                                borderColor: '#9c27b0',
                                backgroundColor: 'rgba(156, 39, 176, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Temperature (¬∞C) / Humidity (%)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Gas (ppm) / PM2.5 (Œºg/m¬≥)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        maintainAspectRatio: false,
                        responsive: true
                    }
                }
            );

            charts.gasDetails = new Chart(
                document.getElementById('gas-details-chart'),
                {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Gas Level (ppm)',
                            data: [],
                            backgroundColor: '#4BC0C0',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Gas Concentration (ppm)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
