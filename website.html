<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIR QUALITY INDEX MONITORING</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --dark-color: #333;
            --light-color: #f4f4f4;
            --danger-color: #ff6b6b;
            --warning-color: #ffb142;
            --success-color: #1dd1a1;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-align: center;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .location {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1rem;
            margin-top: 1rem;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        
        .card-title {
            font-size: 1.25rem;
            color: var(--primary-color);
        }
        
        .card-icon {
            font-size: 1.5rem;
            color: var(--secondary-color);
        }
        
        .reading {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin: 1.5rem 0;
        }
        
        .reading-unit {
            font-size: 1rem;
            color: #888;
        }
        
        .chart-container {
            height: 200px;
            margin-top: 1rem;
        }
        
        .status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
        }
        
        .status-good {
            background-color: var(--success-color);
        }
        
        .status-moderate {
            background-color: var(--warning-color);
        }
        
        .status-poor {
            background-color: var(--danger-color);
        }
        
        .charts {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }
        
        .chart-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 1rem;
        }
        
        .chart-tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .chart-tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .chart-panel {
            display: none;
            height: 400px;
        }
        
        .chart-panel.active {
            display: block;
        }
        
        .prediction {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-top: 2rem;
        }
        
        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        
        .prediction-title {
            font-size: 1.25rem;
            color: var(--primary-color);
        }
        
        .prediction-result {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .prediction-item {
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 0.5rem;
            border-left: 4px solid var(--primary-color);
        }
        
        .prediction-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .prediction-value {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .footer {
            text-align: center;
            margin-top: 2rem;
            padding: 1rem;
            color: #888;
            font-size: 0.875rem;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background-color: rgba(255, 107, 107, 0.1);
            border-left: 4px solid var(--danger-color);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.25rem;
        }
        
        .refresh-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .refresh-btn:hover {
            background-color: #388e3c;
        }

        #data-table {
            width: 100%;
            margin-top: 2rem;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        #data-table th, #data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        #data-table th {
            background-color: #f4f4f4;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        #data-table tr:last-child td {
            border-bottom: none;
        }
        
        #data-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .download-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .download-btn:hover {
            background-color: #0b7dda;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AIR QUALITY INDEX MONITORING</h1>
            <p>Real-time environmental data monitoring and analysis</p>
            <div class="location">
                <span id="location-icon">üìç</span>
                <span id="current-location">Loading location...</span>
            </div>
        </header>
        
        <div class="dashboard">
            <div class="card" id="temperature-card">
                <div class="card-header">
                    <h2 class="card-title">Temperature</h2>
                    <span class="card-icon">üå°Ô∏è</span>
                </div>
                <div class="reading" id="temperature-reading">
                    -- <span class="reading-unit">¬∞C</span>
                </div>
                <div class="chart-container">
                    <canvas id="temperature-chart"></canvas>
                </div>
            </div>
            
            <div class="card" id="humidity-card">
                <div class="card-header">
                    <h2 class="card-title">Humidity</h2>
                    <span class="card-icon">üíß</span>
                </div>
                <div class="reading" id="humidity-reading">
                    -- <span class="reading-unit">%</span>
                </div>
                <div class="chart-container">
                    <canvas id="humidity-chart"></canvas>
                </div>
            </div>
            
            <div class="card" id="gas-card">
                <div class="card-header">
                    <h2 class="card-title">Gas Level</h2>
                    <span class="card-icon">üå´Ô∏è</span>
                </div>
                <div class="reading" id="gas-reading">
                    -- <span class="reading-unit">ppm</span>
                </div>
                <div>
                    <span class="status" id="gas-status">Unknown</span>
                </div>
                <div class="chart-container">
                    <canvas id="gas-chart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="charts">
            <div class="chart-tabs">
                <div class="chart-tab active" data-tab="all-parameters">All Parameters</div>
                <div class="chart-tab" data-tab="gas-details">Gas Details</div>
                <div class="chart-tab" data-tab="correlation">Correlation</div>
            </div>
            
            <div class="chart-panel active" id="all-parameters-panel">
                <canvas id="all-parameters-chart"></canvas>
            </div>
            
            <div class="chart-panel" id="gas-details-panel">
                <canvas id="gas-details-chart"></canvas>
            </div>
            
            <div class="chart-panel" id="correlation-panel">
                <canvas id="correlation-chart"></canvas>
            </div>
        </div>
        
        <div class="prediction">
            <div class="prediction-header">
                <h2 class="prediction-title">AI Prediction Results</h2>
                <button class="refresh-btn" id="refresh-prediction">
                    Refresh Prediction
                </button>
            </div>
            
            <div class="prediction-result">
                <div class="prediction-item">
                    <div class="prediction-label">Predicted Gas Level</div>
                    <div class="prediction-value" id="predicted-gas">--</div>
                </div>
                
                <div class="prediction-item">
                    <div class="prediction-label">Pollutant Type</div>
                    <div class="prediction-value" id="pollutant-type">--</div>
                </div>
                
                <div class="prediction-item">
                    <div class="prediction-label">Air Quality</div>
                    <div class="prediction-value" id="air-quality">--</div>
                </div>
                
                <div class="prediction-item">
                    <div class="prediction-label">Confidence Score</div>
                    <div class="prediction-value" id="confidence-score">--</div>
                </div>
            </div>
        </div>
        
        <div class="data-section">
            <h2>Historical Data</h2>
            <div id="table-container">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Temperature (¬∞C)</th>
                            <th>Humidity (%)</th>
                            <th>Gas (ppm)</th>
                            <th>Pollutant Type</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        <tr>
                            <td colspan="5" class="loading">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button class="download-btn" id="download-csv">
                Download CSV Data
            </button>
        </div>
        
        <footer class="footer">
            <p>Air Quality Index Monitoring System ¬© 2025</p>
        </footer>
    </div>

    <script>
        const CHANNEL_ID = '2918627'; // Replace with your ThingSpeak channel ID
        const API_KEY = '3TW5RRLGEWUWSPES'; // Replace with your ThingSpeak read API key
        const MAX_POINTS = 10;
        let allData = [];
        let charts = {};
        let locationData = {};

        class AirQualityModel {
            constructor(data) {
                this.xgbCoefficients = {
                    temperature: 0.5,
                    humidity: 0.3,
                    intercept: 10
                };
                this.scalers = {
                    temperature: { mean: 25, std: 5 },
                    humidity: { mean: 60, std: 15 },
                    gas: { mean: 300, std: 150 }
                };
                if (data && data.length > 0) {
                    this.updateScalers(data);
                }
            }

            updateScalers(data) {
                const temps = data.map(d => d.temperature).filter(v => !isNaN(v));
                const hums = data.map(d => d.humidity).filter(v => !isNaN(v));
                const gases = data.map(d => d.gas).filter(v => !isNaN(v));
                if (temps.length > 0) {
                    this.scalers.temperature.mean = temps.reduce((a, b) => a + b, 0) / temps.length;
                    this.scalers.temperature.std = Math.sqrt(
                        temps.reduce((a, b) => a + Math.pow(b - this.scalers.temperature.mean, 2), 0) / temps.length
                    ) || 1;
                }
                if (hums.length > 0) {
                    this.scalers.humidity.mean = hums.reduce((a, b) => a + b, 0) / hums.length;
                    this.scalers.humidity.std = Math.sqrt(
                        hums.reduce((a, b) => a + Math.pow(b - this.scalers.humidity.mean, 2), 0) / hums.length
                    ) || 1;
                }
                if (gases.length > 0) {
                    this.scalers.gas.mean = gases.reduce((a, b) => a + b, 0) / gases.length;
                    this.scalers.gas.std = Math.sqrt(
                        gases.reduce((a, b) => a + Math.pow(b - this.scalers.gas.mean, 2), 0) / gases.length
                    ) || 1;
                }
            }

            standardize(value, feature) {
                return (value - this.scalers[feature].mean) / this.scalers[feature].std;
            }

            unstandardize(value, feature) {
                return value * this.scalers[feature].std + this.scalers[feature].mean;
            }

            predict(temperature, humidity) {
                if (isNaN(temperature) || isNaN(humidity)) {
                    return 0;
                }
                const tempStd = this.standardize(temperature, 'temperature');
                const humidityStd = this.standardize(humidity, 'humidity');
                const gasStd =
                    this.xgbCoefficients.temperature * tempStd +
                    this.xgbCoefficients.humidity * humidityStd +
                    this.xgbCoefficients.intercept;
                return Math.max(0, this.unstandardize(gasStd, 'gas'));
            }

            detectGasType(concentration) {
                if (concentration < 150) {
                    return "Clean Air";
                } else if (concentration < 300) {
                    return "CO (Carbon Monoxide)";
                } else if (concentration < 450) {
                    return "NO2 (Nitrogen Dioxide)";
                } else if (concentration < 600) {
                    return "NH3 (Ammonia)";
                } else if (concentration < 1000) {
                    return "Mixed Pollutants";
                } else {
                    return "Hazardous Air";
                }
            }

            calculateConfidence(temperature, humidity) {
                if (isNaN(temperature) || isNaN(humidity)) {
                    return "50.0%";
                }
                const tempDist = Math.abs(this.standardize(temperature, 'temperature'));
                const humDist = Math.abs(this.standardize(humidity, 'humidity'));
                let confidence = 100 - (tempDist + humDist) * 10;
                return Math.max(Math.min(confidence, 100), 50).toFixed(1) + '%';
            }

            getAirQuality(gasLevel) {
                if (gasLevel < 150) {
                    return { label: "Good", class: "status-good" };
                } else if (gasLevel < 450) {
                    return { label: "Moderate", class: "status-moderate" };
                } else {
                    return { label: "Poor", class: "status-poor" };
                }
            }
        }

        let model = new AirQualityModel();

        function initCharts() {
            charts.temperature = new Chart(
                document.getElementById('temperature-chart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Temperature',
                            data: [],
                            borderColor: '#FF6384',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        maintainAspectRatio: false,
                        animation: {
                            duration: 500
                        }
                    }
                }
            );

            charts.humidity = new Chart(
                document.getElementById('humidity-chart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Humidity',
                            data: [],
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        maintainAspectRatio: false,
                        animation: {
                            duration: 500
                        }
                    }
                }
            );

            charts.gas = new Chart(
                document.getElementById('gas-chart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Gas',
                            data: [],
                            borderColor: '#4BC0C0',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        maintainAspectRatio: false,
                        animation: {
                            duration: 500
                        }
                    }
                }
            );

            charts.allParameters = new Chart(
                document.getElementById('all-parameters-chart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Temperature (¬∞C)',
                                data: [],
                                borderColor: '#FF6384',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Humidity (%)',
                                data: [],
                                borderColor: '#36A2EB',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Gas (ppm)',
                                data: [],
                                borderColor: '#4BC0C0',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Temperature (¬∞C) / Humidity (%)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Gas (ppm)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        maintainAspectRatio: false,
                        responsive: true
                    }
                }
            );

            charts.gasDetails = new Chart(
                document.getElementById('gas-details-chart'),
                {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Gas Level (ppm)',
                            data: [],
                            backgroundColor: '#4BC0C0',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Gas Concentration (ppm)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        maintainAspectRatio: false,
                        responsive: true
                    }
                }
            );

            charts.correlation = new Chart(
                document.getElementById('correlation-chart'),
                {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Temperature vs Gas',
                            data: [],
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            pointRadius: 5
                        }, {
                            label: 'Humidity vs Gas',
                            data: [],
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            pointRadius: 5
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Temperature (¬∞C) / Humidity (%)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Gas Level (ppm)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.datasetIndex === 0) {
                                            label += `(${context.parsed.x.toFixed(1)}¬∞C, ${context.parsed.y.toFixed(1)} ppm)`;
                                        } else {
                                            label += `(${context.parsed.x.toFixed(1)}%, ${context.parsed.y.toFixed(1)} ppm)`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        maintainAspectRatio: false,
                        responsive: true
                    }
                }
            );
        }

        async function fetchData(retryCount = 3) {
            console.log(`Attempting to fetch data from ThingSpeak (Attempt ${4 - retryCount}/3)`);
            try {
                const response = await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${API_KEY}&results=50`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status} - ${response.statusText}`);
                }
                const data = await response.json();
                console.log('ThingSpeak API response:', data);
                if (!data || !data.feeds || !Array.isArray(data.feeds)) {
                    throw new Error('Invalid data format: feeds array is missing or malformed');
                }
                if (data.feeds.length === 0) {
                    throw new Error('No data feeds available from ThingSpeak');
                }
                processData(data.feeds);
                storeDataAsCSV(data.feeds);
                return data.feeds;
            } catch (error) {
                console.error('Error fetching ThingSpeak data:', error.message);
                if (retryCount > 1) {
                    console.log(`Retrying... (${retryCount - 1} attempts left)`);
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds before retry
                    return fetchData(retryCount - 1);
                }
                showError(`Failed to fetch data from ThingSpeak: ${error.message}. Please check your API key and channel ID.`);
                return [];
            }
        }

        function processData(feeds) {
            if (!feeds || feeds.length === 0) {
                showError('No data feeds to process.');
                return;
            }
            allData = feeds.map(feed => {
                const timestamp = new Date(feed.created_at);
                const temperature = parseFloat(feed.field1) || 0;
                const humidity = parseFloat(feed.field2) || 0;
                const gas = parseFloat(feed.field3) || 0;
                const gasType = model.detectGasType(gas);
                return {
                    timestamp,
                    formattedTime: formatTime(timestamp),
                    temperature,
                    humidity,
                    gas,
                    gasType
                };
            }).filter(item => !isNaN(item.temperature) && !isNaN(item.humidity) && !isNaN(item.gas) && item.timestamp.getTime());

            console.log('Processed data:', allData);
            if (allData.length > 0) {
                model = new AirQualityModel(allData);
                console.log('Updated model scalers:', model.scalers);
                updateDashboard(allData[allData.length - 1]);
                updateCharts(allData);
                updateTable(allData);
                runPrediction(allData[allData.length - 1]);
            } else {
                showError('No valid data points available for processing.');
            }
        }

        function updateDashboard(latestData) {
            document.getElementById('temperature-reading').innerHTML = 
                `${latestData.temperature.toFixed(1)} <span class="reading-unit">¬∞C</span>`;
            document.getElementById('humidity-reading').innerHTML = 
                `${latestData.humidity.toFixed(1)} <span class="reading-unit">%</span>`;
            document.getElementById('gas-reading').innerHTML = 
                `${latestData.gas.toFixed(1)} <span class="reading-unit">ppm</span>`;
            const gasStatus = model.getAirQuality(latestData.gas);
            const statusElement = document.getElementById('gas-status');
            statusElement.textContent = gasStatus.label;
            statusElement.className = `status ${gasStatus.class}`;
        }

        function updateCharts(data) {
            const recentData = data.slice(-MAX_POINTS);
            const labels = recentData.map(d => d.formattedTime);
            charts.temperature.data.labels = labels;
            charts.temperature.data.datasets[0].data = recentData.map(d => d.temperature);
            charts.temperature.update();
            charts.humidity.data.labels = labels;
            charts.humidity.data.datasets[0].data = recentData.map(d => d.humidity);
            charts.humidity.update();
            charts.gas.data.labels = labels;
            charts.gas.data.datasets[0].data = recentData.map(d => d.gas);
            charts.gas.update();
            charts.allParameters.data.labels = data.map(d => d.formattedTime);
            charts.allParameters.data.datasets[0].data = data.map(d => d.temperature);
            charts.allParameters.data.datasets[1].data = data.map(d => d.humidity);
            charts.allParameters.data.datasets[2].data = data.map(d => d.gas);
            charts.allParameters.update();
            charts.gasDetails.data.labels = data.map(d => d.formattedTime);
            charts.gasDetails.data.datasets[0].data = data.map(d => d.gas);
            charts.gasDetails.update();
            const tempGasCorrelation = data.map(d => ({
                x: d.temperature,
                y: d.gas
            }));
            const humGasCorrelation = data.map(d => ({
                x: d.humidity,
                y: d.gas
            }));
            charts.correlation.data.datasets[0].data = tempGasCorrelation;
            charts.correlation.data.datasets[1].data = humGasCorrelation;
            charts.correlation.update();
        }

        function updateTable(data) {
            const tableBody = document.getElementById('data-table-body');
            tableBody.innerHTML = '';
            const sortedData = [...data].sort((a, b) => b.timestamp - a.timestamp);
            const recentData = sortedData.slice(0, 20);
            if (recentData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5">No data available</td></tr>';
                return;
            }
            recentData.forEach(item => {
                const row = document.createElement('tr');
                const formattedDate = item.timestamp.toLocaleString();
                const gasStatus = model.getAirQuality(item.gas);
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${item.temperature.toFixed(1)} ¬∞C</td>
                    <td>${item.humidity.toFixed(1)} %</td>
                    <td>${item.gas.toFixed(1)} ppm</td>
                    <td>
                        <span class="status-indicator" style="background-color: ${getColorForGasType(item.gasType)}"></span>
                        ${item.gasType}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function getColorForGasType(gasType) {
            switch(gasType) {
                case "Clean Air":
                    return '#1dd1a1';
                case "CO (Carbon Monoxide)":
                    return '#ffb142';
                case "NO2 (Nitrogen Dioxide)":
                    return '#ff9f43';
                case "NH3 (Ammonia)":
                    return '#ee5253';
                case "Mixed Pollutants":
                    return '#ff6b6b';
                case "Hazardous Air":
                    return '#b71540';
                default:
                    return '#777';
            }
        }

        function runPrediction(latestData) {
            const temperature = latestData.temperature;
            const humidity = latestData.humidity;
            const predictedGas = model.predict(temperature, humidity);
            const pollutantType = model.detectGasType(predictedGas);
            const airQuality = model.getAirQuality(predictedGas);
            const confidenceScore = model.calculateConfidence(temperature, humidity);
            document.getElementById('predicted-gas').textContent = `${predictedGas.toFixed(1)} ppm`;
            document.getElementById('pollutant-type').textContent = pollutantType;
            document.getElementById('air-quality').textContent = airQuality.label;
            document.getElementById('confidence-score').textContent = confidenceScore;
            const airQualityElement = document.getElementById('air-quality');
            airQualityElement.innerHTML = `<span class="status ${airQuality.class}">${airQuality.label}</span>`;
        }

        function storeDataAsCSV(feeds) {
            const processedData = feeds.map(feed => {
                const timestamp = new Date(feed.created_at);
                const temperature = parseFloat(feed.field1) || 0;
                const humidity = parseFloat(feed.field2) || 0;
                const gas = parseFloat(feed.field3) || 0;
                const gasType = model.detectGasType(gas);
                return {
                    timestamp: timestamp.toISOString(),
                    temperature,
                    humidity,
                    gas,
                    gas_type: gasType
                };
            }).filter(item => !isNaN(item.temperature) && !isNaN(item.humidity) && !isNaN(item.gas));
            const csvContent = Papa.unparse(processedData);
            localStorage.setItem('airQualityData', csvContent);
            return csvContent;
        }

        function downloadCSV() {
            const csvContent = localStorage.getItem('airQualityData') || '';
            if (!csvContent) {
                alert('No data available to download.');
                return;
            }
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'air_quality_data.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function showError(message) {
            console.warn('Error displayed:', message);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            const container = document.querySelector('.container');
            container.insertBefore(errorDiv, container.firstChild);
            setTimeout(() => {
                errorDiv.remove();
            }, 10000);
        }

        function getCurrentLocation() {
            if (!window.isSecureContext) {
                showError('Geolocation requires a secure context (HTTPS or localhost). Please host the page on a secure server.');
                document.getElementById('current-location').textContent = 'Secure context required';
                return;
            }
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by this browser.');
                document.getElementById('current-location').textContent = 'Geolocation not supported';
                return;
            }
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    console.log(`Geolocation success: Latitude=${lat}, Longitude=${lon}`);
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`, {
                            headers: {
                                'User-Agent': 'AirQualityMonitor/1.0'
                            }
                        });
                        if (!response.ok) {
                            throw new Error(`Nominatim HTTP error! Status: ${response.status}`);
                        }
                        const data = await response.json();
                        console.log('Nominatim API response:', data);
                        let location = 'Unknown Location';
                        if (data && data.address) {
                            if (data.address.city) {
                                location = data.address.city;
                            } else if (data.address.town) {
                                location = data.address.town;
                            } else if (data.address.village) {
                                location = data.address.village;
                            }
                            if (data.address.state) {
                                location += location !== 'Unknown Location' ? `, ${data.address.state}` : data.address.state;
                            }
                        }
                        document.getElementById('current-location').textContent = location;
                        locationData = { lat, lon, location };
                    } catch (error) {
                        console.error('Error getting location name:', error.message);
                        showError(`Failed to fetch location name: ${error.message}. Using coordinates instead.`);
                        document.getElementById('current-location').textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                    }
                },
                (error) => {
                    console.error('Geolocation error:', error.message);
                    let errorMessage = 'Location unavailable';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied by user.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out.';
                            break;
                    }
                    showError(`Geolocation failed: ${errorMessage}`);
                    document.getElementById('current-location').textContent = errorMessage;
                },
                {
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        function initTabs() {
            const tabs = document.querySelectorAll('.chart-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.chart-panel').forEach(panel => {
                        panel.classList.remove('active');
                    });
                    const panelId = `${tab.dataset.tab}-panel`;
                    document.getElementById(panelId).classList.add('active');
                    Object.values(charts).forEach(chart => chart.resize());
                });
            });
        }

        async function init() {
            if (!window.isSecureContext) {
                showError('This application requires a secure context (HTTPS or localhost) for API and geolocation features.');
            }
            initCharts();
            initTabs();
            getCurrentLocation();
            await fetchData();
            setInterval(fetchData, 30000);
            document.getElementById('refresh-prediction').addEventListener('click', () => {
                if (allData.length > 0) {
                    runPrediction(allData[allData.length - 1]);
                } else {
                    showError('No data available for prediction.');
                }
            });
            document.getElementById('download-csv').addEventListener('click', downloadCSV);
        }

        document.addEventListener('DOMContentLoaded', init);

        class BackendSimulation {
            constructor() {
                this.dataFile = 'air_quality_data.csv';
                setInterval(() => this.processDataForML(), 60000);
            }

            processDataForML() {
                console.log("Backend: Processing data for ML model");
                console.log("Backend: ML processing complete");
            }

            getHistoricalAnalysis() {
                const analysis = {
                    averageTemperature: 0,
                    averageHumidity: 0,
                    averageGas: 0,
                    dominantGasType: '',
                    recommendations: []
                };
                if (allData.length > 0) {
                    analysis.averageTemperature = allData.reduce((sum, item) => sum + item.temperature, 0) / allData.length;
                    analysis.averageHumidity = allData.reduce((sum, item) => sum + item.humidity, 0) / allData.length;
                    analysis.averageGas = allData.reduce((sum, item) => sum + item.gas, 0) / allData.length;
                    const gasTypeCounts = {};
                    allData.forEach(item => {
                        gasTypeCounts[item.gasType] = (gasTypeCounts[item.gasType] || 0) + 1;
                    });
                    let maxCount = 0;
                    for (const gasType in gasTypeCounts) {
                        if (gasTypeCounts[gasType] > maxCount) {
                            maxCount = gasTypeCounts[gasType];
                            analysis.dominantGasType = gasType;
                        }
                    }
                    if (analysis.averageGas < 150) {
                        analysis.recommendations.push("Air quality is good. No action needed.");
                    } else if (analysis.averageGas < 300) {
                        analysis.recommendations.push("Consider improving ventilation in the monitored area.");
                        analysis.recommendations.push("Monitor CO levels and ensure CO detectors are working.");
                    } else if (analysis.averageGas < 450) {
                        analysis.recommendations.push("Check for potential NO2 sources in the area.");
                        analysis.recommendations.push("Improve ventilation and avoid extended exposure.");
                    } else if (analysis.averageGas < 600) {
                        analysis.recommendations.push("High ammonia levels detected. Check for leaks or industrial sources.");
                        analysis.recommendations.push("Evacuate area if levels continue to rise.");
                    } else {
                        analysis.recommendations.push("HAZARDOUS AIR QUALITY! Take immediate action.");
                        analysis.recommendations.push("Evacuate the area and contact environmental authorities.");
                    }
                }
                return analysis;
            }
        }

        const backend = new BackendSimulation();
    </script>
</body>
</html>
